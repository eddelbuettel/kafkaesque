---
output: github_document
---

<style>body {max-width: 1100px; margin: auto; padding: 1em; line-height: 20px ;}</style>

  <!-- README.md is generated from README.Rmd. Please edit that file -->


<!-- -->
<!-- FILL OUT OPTIONS !!! -->
<!-- -->
```{r scaffolding options, include=FALSE}
github_user_name   <- "petermeissner"
codecov_user_name  <- github_user_name
travis_user_name   <- github_user_name
appveyor_user_name <- github_user_name
```
<!-- -->
<!-- -->




```{r knitr options, echo = FALSE}
knitr::opts_chunk$set(
  fig.path = "man/figures/README-"
)
```


```{r r options, include=FALSE}
options("width" = 130)
options(scipen = 20)

# get package info
tmp <- packageDescription( "kafkaesque" )

package_name <- tmp$Package

```

```{r readme title, results='asis', echo=FALSE}
cat("#", tmp$Title)
```




**Status**


<a href="https://travis-ci.org/`r travis_user_name`/`r package_name`"><img src="https://api.travis-ci.org/`r github_user_name`/`r package_name`.svg?branch=master"><a/>
[![AppVeyor build status](https://ci.appveyor.com/api/projects/status/github/`r github_user_name`/`r package_name`?branch=master&svg=true)](https://ci.appveyor.com/project/`r github_user_name`/`r package_name`)
<a href="https://codecov.io/gh/`r github_user_name`/`r package_name`"><img src="https://codecov.io/gh/`r codecov_user_name`/`r package_name`/branch/master/graph/badge.svg" alt="Codecov" /></a>
<a href="https://cran.r-project.org/package=`r package_name`">
<img src="http://www.r-pkg.org/badges/version/`r package_name`">
</a>
<img src="http://cranlogs.r-pkg.org/badges/grand-total/`r package_name`">
<img src="http://cranlogs.r-pkg.org/badges/`r package_name`">






```{r, include=FALSE}
filelist.R     <- list.files("R", recursive = TRUE, pattern="\\.R$", ignore.case = TRUE, full.names = TRUE)
filelist.Java  <- list.files("java/kafkaesque/src/main/java/kafkaesque", recursive = TRUE, pattern="\\.java$", ignore.case = TRUE, full.names = TRUE)
filelist.tests   <- list.files("tests", recursive = TRUE, pattern="\\.R$", ignore.case = TRUE, full.names = TRUE)
filelist.cpp <- list.files("src", recursive = TRUE, pattern="\\.cpp$", ignore.case = TRUE, full.names = TRUE)
lines.R      <- unlist(lapply(filelist.R, readLines))
lines.Java   <- unlist(lapply(filelist.Java, readLines, warn=FALSE))
lines.tests  <- unlist(lapply(filelist.tests, readLines))
lines.cpp    <- unlist(lapply(filelist.cpp, readLines))
length.R     <- length(grep("(^\\s*$)|(^\\s*#)|(^\\s*//)", lines.R,  value = TRUE, invert = TRUE))
length.Java  <- length(grep("(^\\s*$)|(^\\s*/*\\*)|(^\\s*#)|(^\\s*//)", lines.Java,  value = TRUE, invert = TRUE))
length.tests <- length(grep("(^\\s*$)|(^\\s*#)|(^\\s*//)", lines.tests,  value = TRUE, invert = TRUE))
length.cpp   <- length(grep("(^\\s*$)|(^\\s*#)|(^\\s*//)", lines.cpp,  value = TRUE, invert = TRUE))
```


*lines of R code:* `r length.R`, *lines of Java code:* `r length.Java`, *lines of test code:* `r length.tests`



**Version**

```{r, include=FALSE}
source_files <-
  grep(
    "/R/|/src/|/tests/",
    list.files(recursive = TRUE, full.names = TRUE),
    value = TRUE
  )
last_change <-
  as.character(
    format(max(file.info(source_files)$mtime), tz="UTC")
  )
```


```{r, results='asis', echo=FALSE}
cat(tmp$Version, "(",last_change,")")
```

**Description**


```{r, results='asis', echo=FALSE}
cat(tmp$Description)
```


**License**

```{r, results='asis', echo=FALSE}
cat(tmp$License, "<br>")
cat(tmp$Author)
```



**Citation**


```{r, results='asis', echo=FALSE}
cat("```r\n")
cat("citation(\"",package_name,"\")", sep = "")
cat("\n```\n")
```

```{r, results='asis', echo=FALSE}
cat("```r\n")
print_text <- capture.output(print(citation(package_name), style = "text"))
cat(gsub("_", "", print_text))
cat("\n```\n")
```


**BibTex for citing**

```{r, results='asis', echo=FALSE}
cat("```r\n")
cat("toBibtex(citation(\"",package_name,"\"))", sep = "")
cat("\n```\n")
```

```{r, results='asis', echo=FALSE}
cat("```\n")
cat(as.character(toBibtex(citation(package_name))), sep = "\n")
cat("\n```\n")
```



**Installation**

Stable version from CRAN:

```{r, results='asis', echo=FALSE}
cat("```r\n")
cat("install.packages(\"",package_name,"\")", sep = "")
cat("\n```\n")
```


Latest development version from Github:


```{r, results='asis', echo=FALSE}
cat("```r\n")
cat("devtools::install_github(\"petermeissner/",package_name,"\")", sep = "")
cat("\n```\n")
```

# ToDos

```{r}
kafkaesque::todo
```



# Content 

```{r}
library(kafkaesque)
ls("package:kafkaesque")
```

# Usage


## Start Consumer (... Stop, Status)

```{r}

library("kafkaesque")

# new consumer
consumer <- kafka_consumer()

# starting/connecting - + status
consumer$start()

consumer$running()
consumer$end()$running()
consumer$start()$running()

```



## Properties aka Config

See here for list of consumer properties: https://kafka.apache.org/documentation/#consumerconfigs.


```{r}
consumer$props()
```


```{r}
consumer$props(max.poll.records = 200)
```



## Topics and Subscriptions

```{r}

# list topics available to consumer
consumer$topics_list()

# subscribe to topic
consumer$topics_subscribe("test500000")
consumer$topics_subscription()


```



## Retrieving a Message

```{r}

# retrieve next message
consumer$consume_next()

```


## Looping over Messages and Executing Code


```{r}
# loop over messages and execute code
res <- 
  consumer$consume_loop(
    expr  = expression(print(msgs)),
    check = expression(counter < 4)
  )

# having a look at the statistics
res


```

## Looping over Batches of Messages and Executing Code

```{r}

# loop over batches of messages and execute code
res <- 
  consumer$consume_loop(
    expr  = 
      expression({
        print(msgs)
        cat("\n")
      }),
    check = expression(counter < 1000),
    batch = TRUE
  )

res

```


## Offsets and Seeking


```{r}
# get current offsets from Kafka
consumer$topics_offsets()

# seek to end of topics 
consumer$topics_seek_to_end()
consumer$topics_offsets()

# seek to beginning of topics
consumer$topics_seek_to_beginning()
consumer$topics_offsets()

```





# Developement Notes

For R developement Rstudio was used. For Java developement Visual Studio Code
lend a helping hand with Maven as build tooling. 

For developement two packages are needed:

- {kafkaesquejars} serves as place where all Java dependency Jars are put to 
comply with CRAN best practices on publishing Java wrapper packages
- {kafkaesque} contains all the R functions, classes and methods and also all 
Java code that is specific to this project (and not just a dependency)

Java sources are in `./java/kafkaesque/` folder. Building Java sources can be 
done via Maven: `mvn install` will compile everything and copy the `kafkaesque.jar`
into the package's `./inst/java/` folder while all dependencies are copied
into the `./inst/java/` folder of the {kafkaesquejars} package. Both packages
should be placed within the same folder to make this work properly.

After Java compilation, both R packages have to be build and installed - first 
{kafkaesquejars} than {kafkaesque}. 

If developing Java in VScode - as I did here - pressing Ctrl-Shift-B should allow 
to select the two most important tasks: resolving dependencies 
(these go into {kafkaesqujars}) and compiling the Java code and distributing it 
to the right places as described above. 


# Vocabulary and Concepts

## Is it a Queue? Is it BigData? Is it Distributed Log? Yes and No: It is Kafka. 

TBD


### Features and Promises

TBD



## Queues and Topics

TBD



## Conumers and Producers

TBD



